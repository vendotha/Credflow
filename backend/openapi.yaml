openapi: 3.0.3
info:
  title: CredFlow API
  version: 1.0.0
  description: Referral & Credit System â€“ REST API (first purchase credits both users)
servers:
  - url: https://credflow-api.onrender.com
    description: Production
  - url: http://localhost:8080
    description: Local
tags:
  - name: Health
  - name: Users
  - name: Referrals
  - name: Purchases
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    User:
      type: object
      properties:
        id: { type: string }
        email: { type: string }
        name: { type: string }
        credits: { type: integer, example: 2 }
        referralCode: { type: string, example: LINA12-ABCD1 }
    Stats:
      type: object
      properties:
        totalReferredUsers: { type: integer, example: 10 }
        convertedUsers: { type: integer, example: 4 }
        totalCredits: { type: integer, example: 8 }
    InitUserRequest:
      type: object
      required: [email]
      properties:
        email: { type: string, example: lina@example.com }
        name: { type: string, example: Lina Ray }
    BindReferralRequest:
      type: object
      required: [code]
      properties:
        code: { type: string, example: LINA12-ABCD1 }
    PurchaseRequest:
      type: object
      properties:
        amount: { type: number, example: 0, minimum: 0, default: 10 }
paths:
  /api/health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
  /api/users/init:
    post:
      tags: [Users]
      security: [ { bearerAuth: [] } ]
      summary: Create or ensure user exists (idempotent)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/InitUserRequest' }
      responses:
        '200':
          description: User ensured/created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '400': { description: Invalid body }
        '401': { description: Unauthorized }
  /api/users/me:
    get:
      tags: [Users]
      security: [ { bearerAuth: [] } ]
      summary: Get current user profile
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Unauthorized }
        '404': { description: Not found }
  /api/referrals/stats:
    get:
      tags: [Referrals]
      security: [ { bearerAuth: [] } ]
      summary: Get referral stats for the current user
      responses:
        '200':
          description: Stats
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Stats' }
        '401': { description: Unauthorized }
  /api/referrals/bind:
    post:
      tags: [Referrals]
      security: [ { bearerAuth: [] } ]
      summary: Bind a referral code to the current user (idempotent)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BindReferralRequest' }
      responses:
        '200':
          description: Bound or already bound
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  alreadyBound: { type: boolean, example: false }
        '400': { description: Invalid code or self-referral }
        '401': { description: Unauthorized }
        '404': { description: User or code not found }
  /api/purchases:
    post:
      tags: [Purchases]
      security: [ { bearerAuth: [] } ]
      summary: Simulate a purchase; on first referred purchase credits both users
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PurchaseRequest' }
      responses:
        '200':
          description: Purchase recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  credited: { type: boolean, example: true }
        '400': { description: Invalid body }
        '401': { description: Unauthorized }
